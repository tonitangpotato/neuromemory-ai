meta:
  version: '2.0'
  domain: engram-embedding
  schema:
    relations:
      code:
        - implements
        - depends_on
        - calls
        - tested_by
      semantic:
        - enables
        - blocks
        - requires
        - precedes
nodes:
  Phase1:
    type: Feature
    description: Default Sentence Transformers embedding
    priority: core
    status: draft
    tasks:
      - '[x] Modify mcp_server.py to enable SentenceTransformerAdapter'
      - '[x] Set default model: all-MiniLM-L6-v2'
      - '[ ] Add vector generation on first startup'
      - '[x] Test cross-language recall (English → Chinese)'
      - '[x] Test synonym recall (marketing → 推广)'
      - '[x] Test fuzzy matching (困难 → 难题)'
  MCPServerModification:
    type: Component
    layer: application
    description: Update MCP server initialization with embedding
    status: draft
    path: engram/mcp_server.py
  VectorGeneration:
    type: Component
    layer: infrastructure
    description: Generate vectors for existing memories
    status: draft
  RecallTesting:
    type: Test
    description: Validate semantic recall quality
    status: draft
  Phase2:
    type: Feature
    description: Environment variable configuration
    priority: supporting
    status: draft
    tasks:
      - '[x] Add ENGRAM_EMBEDDING env var parsing'
      - '[x] Support sentence-transformers/ollama/openai/none'
      - '[x] Document configuration in README'
      - '[x] Add error handling for missing dependencies'
      - '[ ] Test all provider options'
  EnvVarSupport:
    type: Component
    layer: application
    description: Parse and apply ENGRAM_EMBEDDING config
    status: draft
    path: engram/mcp_server.py
  Documentation:
    type: File
    description: Configuration guide in README
    status: draft
    path: README.md
  Phase3:
    type: Feature
    description: Graceful degradation fallback chain
    priority: generic
    status: draft
    tasks:
      - '[x] Implement provider detection logic'
      - '[ ] Add fallback chain: Ollama → ST → FTS5'
      - '[x] Add embedding_status MCP tool'
      - '[ ] Log provider selection'
      - '[ ] Test all fallback scenarios'
  ProviderDetection:
    type: Component
    layer: infrastructure
    description: Detect available embedding providers
    status: draft
  EmbeddingStatusTool:
    type: Component
    layer: application
    description: MCP tool to query current embedding provider
    status: draft
    path: engram/mcp_server.py
edges:
  - from: Phase2
    to: Phase1
    relation: requires
  - from: Phase3
    to: Phase2
    relation: requires
  - from: MCPServerModification
    to: Phase1
    relation: implements
  - from: VectorGeneration
    to: Phase1
    relation: implements
  - from: RecallTesting
    to: Phase1
    relation: tested_by
  - from: VectorGeneration
    to: MCPServerModification
    relation: depends_on
  - from: RecallTesting
    to: VectorGeneration
    relation: requires
  - from: EnvVarSupport
    to: Phase2
    relation: implements
  - from: Documentation
    to: Phase2
    relation: implements
  - from: EnvVarSupport
    to: MCPServerModification
    relation: depends_on
  - from: ProviderDetection
    to: Phase3
    relation: implements
  - from: EmbeddingStatusTool
    to: Phase3
    relation: implements
  - from: ProviderDetection
    to: EnvVarSupport
    relation: depends_on
  - from: EmbeddingStatusTool
    to: ProviderDetection
    relation: depends_on
